rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email in [
               'frankmathewsajan@gmail.com',
               'aayushspillai@gmail.com', 
               'houseofmuziris@gmail.com'
             ];
    }
    
    function isMember() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/members/$(request.auth.token.email));
    }
    
    // Requests Collection - Membership applications
    match /requests/{requestId} {
      allow create: if true; // Anyone can apply
      allow read: if isAdmin(); // Only admins can view requests
      allow update: if isAdmin(); // Only admins can approve/reject
      allow delete: if isAdmin();
    }
    
    // Members Collection - User profiles (document ID is email)
    match /members/{email} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        request.auth.token.email == email
      );
      allow create: if isAuthenticated() && 
                       request.auth.token.email == email;
      allow update: if isAuthenticated() && 
                       request.auth.token.email == email;
      allow delete: if isAdmin();
      
      // Cart subcollection
      match /cart/{itemId} {
        allow read, write: if isAuthenticated() && 
                              request.auth.token.email == email;
      }
    }
    
    // Spices catalog - Everyone can read, only admins can write
    match /spices/{spiceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
